grammar org.xtext.globalTypes.MyDsl with org.eclipse.xtext.common.Terminals

generate myDsl "http://www.xtext.org/globalTypes/MyDsl"

Model:
	protocol = GlobalProtocol | protocol = LocalProtocol
;

GlobalProtocol:
	'global' 'protocol' protocolName=ID '(' roles=Roles '){'protocol=Protocol'}'
	;
	
Roles:
	roles+=Role (',' roles+=Role)*
;

Role:
	RoleOne | RoleSet
;

RoleOne:
	'role' name=ID
;

RoleSet:
	'roleset' name=ID ':' ref=[RoleOne | ID]
;
    

Protocol:
	{Protocol} (actions+=(Message | Choice | Recursion | ForEach))* (doesEnd='End')? | actions+=(CloseRecursion)
;

Recursion:
	'rec' name=ID ':''{'
		recProtocol=Protocol
	'}'
;

CloseRecursion:
	'loop' recursionVariable=[Recursion | ID]
;

ForEach:

	'for' loopRole=RoleOne ':' '<'roleset=[RoleSet | ID] ',' refRole = [RoleOne | ID] '>' '{'
		branch=Protocol
	'}'';'
;

Choice:
	'choice' 'at' role=[RoleOne | ID] '{'
		branches+=ChoiceBranch
	'}' ('or' '{'
		branches+=ChoiceBranch
	'}')*
;

ChoiceBranch:
	message=Message
	protocol=Protocol
;

Message:
	messageType=ID '(' payload=Payload? ')' 'from' sender=[RoleOne | ID] 'to' receiver=[Role | ID] '.'
;

Payload:
	{Payload} (types+=Type (','types+=Type)*) | types+=ID
;

LocalProtocol:
	'local' 'protocol' protocolName=ID 'at' projectedRole=ID '(' roles=Roles ')' '{'protocol=ProtocolL'}'
;


ProtocolL:
	{ProtocolL} (actions+=(MessageL | ChoiceL | ForEachL | RecursionL | CloseRecursion))* ('End')?
;

RecursionL:
	'rec' name=ID ':''{'
		recProtocol=ProtocolL
	'}'
;

MessageL:
	messageType=ID '(' payload=Payload? ')' ((target+=SenderL) | (target+=ReceiverL)) '.'
;

SenderL:
	'from' sender=[Role | ID]
;

ReceiverL:
	'to' to=[Role | ID]
;

ChoiceL:
	'choice' 'at' role=[Role | ID] '{'
		branches+=ChoiceBranchL
	'}' ('or' '{'
		branches+=ChoiceBranchL
	'}')*
;

ChoiceBranchL:
	message=MessageL
	protocol=ProtocolL
;

ForEachL:
	'foreach' eachRole=RoleOne ':' '<'role=[RoleSet | ID]','role=[RoleOne | ID]'>' '{'
		branch=ProtocolL
	'}'
;



Type:
	'int' | 'string' | 'action'  //add more
;


